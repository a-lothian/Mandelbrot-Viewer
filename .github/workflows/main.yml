name: Build Mandelbrot

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build"
        required: true
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg-cache

jobs:
  build:
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            triplet: x64-linux-release
          - os: windows-latest
            triplet: x64-windows-static
          - os: macos-latest
            triplet: arm64-osx-release

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/tags/{0}', inputs.tag) || github.ref }}

    - name: Create vcpkg binary cache directory
      shell: bash
      run: mkdir -p "${{ github.workspace }}/vcpkg-cache"

    - name: Cache vcpkg binaries
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/vcpkg-cache
        key: vcpkg-${{ matrix.triplet }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: vcpkg-${{ matrix.triplet }}-

    # Install Linux system dependencies needed for vcpkg to build SDL3
    - name: Install Dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git cmake ninja-build pkg-config \
        autoconf autoconf-archive automake libtool libltdl-dev \
        gperf python3-jinja2 libcap-dev \
        gnome-desktop-testing \
        libasound2-dev libpulse-dev libaudio-dev libjack-dev libsndio-dev libsamplerate0-dev \
        libusb-1.0-0-dev \
        libx11-dev libxext-dev libxrandr-dev libxcursor-dev libxfixes-dev libxi-dev libxss-dev \
        libxinerama-dev libxxf86vm-dev libxtst-dev \
        libwayland-dev libxkbcommon-dev libdrm-dev libgbm-dev \
        libgl1-mesa-dev libgles2-mesa-dev libegl1-mesa-dev \
        libdbus-1-dev libibus-1.0-dev libudev-dev fcitx-libs-dev \
        libdecor-0-dev

    - name: Install Dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: brew install ninja cmake

    # Install vcpkg dependencies using manifest (vcpkg.json)
    - name: Install vcpkg packages
      shell: bash
      run: vcpkg install --triplet ${{ matrix.triplet }}

    # Build Mandelbrot
    - name: Configure Mandelbrot
      shell: bash
      run: |
        generator_flags=""
        if [ "$RUNNER_OS" != "Windows" ]; then
          generator_flags="-G Ninja"
        fi
        cmake -B build -DCMAKE_BUILD_TYPE=Release $generator_flags \
          -DCMAKE_TOOLCHAIN_FILE="${VCPKG_INSTALLATION_ROOT}/scripts/buildsystems/vcpkg.cmake" \
          -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }}

    - name: Build Mandelbrot
      run: cmake --build build --config Release

    - name: Verify Windows Build Output
      if: matrix.os == 'windows-latest'
      shell: bash
      run: |
        if [ ! -f "build/Release/Mandelbrot.exe" ]; then
          echo "ERROR: Windows executable not found at build/Release/Mandelbrot.exe"
          find build -name "*.exe" -o -name "Mandelbrot*"
          exit 1
        fi
        ls -lh build/Release/Mandelbrot.exe

    - name: Verify Linux Build Output
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        if [ ! -f "build/Mandelbrot" ]; then
          echo "ERROR: Linux binary not found at build/Mandelbrot"
          find build -type f -executable
          exit 1
        fi
        ls -lh build/Mandelbrot

    - name: Verify macOS Build Output
      if: matrix.os == 'macos-latest'
      shell: bash
      run: |
        if [ ! -f "build/Mandelbrot" ]; then
          echo "ERROR: macOS binary not found at build/Mandelbrot"
          find build -type f -executable
          exit 1
        fi
        ls -lh build/Mandelbrot

    # Packaging - Windows is now a standalone exe
    - name: Upload Windows Artifact
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: Mandelbrot-Windows
        path: build/Release/Mandelbrot.exe

    - name: Upload Linux Artifact
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: Mandelbrot-Linux
        path: build/Mandelbrot

    - name: Upload macOS Artifact
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: Mandelbrot-macOS
        path: build/Mandelbrot

  release:
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Verify all artifacts were downloaded
        shell: bash
        run: |
          echo "Artifact directory structure:"
          ls -R dist

          if [ ! -d "dist/Mandelbrot-Windows" ] || [ ! -f "dist/Mandelbrot-Windows/Mandelbrot.exe" ]; then
            echo "ERROR: Windows artifact missing"
            exit 1
          fi
          if [ ! -d "dist/Mandelbrot-Linux" ] || [ ! -f "dist/Mandelbrot-Linux/Mandelbrot" ]; then
            echo "ERROR: Linux artifact missing"
            exit 1
          fi
          if [ ! -d "dist/Mandelbrot-macOS" ] || [ ! -f "dist/Mandelbrot-macOS/Mandelbrot" ]; then
            echo "ERROR: macOS artifact missing"
            exit 1
          fi
          echo "All artifacts verified successfully"

      - name: Package releases
        shell: bash
        run: |
          chmod +x dist/Mandelbrot-Linux/Mandelbrot
          chmod +x dist/Mandelbrot-macOS/Mandelbrot

          tar -czf Mandelbrot-Linux.tar.gz -C dist/Mandelbrot-Linux Mandelbrot
          tar -czf Mandelbrot-macOS.tar.gz -C dist/Mandelbrot-macOS Mandelbrot
          zip -j Mandelbrot-Windows.zip dist/Mandelbrot-Windows/Mandelbrot.exe

          echo "Package creation complete:"
          ls -lh Mandelbrot-*.{tar.gz,zip}

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          files: |
            Mandelbrot-Windows.zip
            Mandelbrot-Linux.tar.gz
            Mandelbrot-macOS.tar.gz
